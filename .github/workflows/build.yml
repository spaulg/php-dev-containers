name: 'Refresh PHP development containers'

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master
  schedule:
    - cron: '0 3 * * 0'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  version_matrix:
    name: Pre Build
    uses: ./.github/workflows/subflow-detect-versions.yml
    secrets: inherit

  build_packages:
    name: Build Packages
    needs: ['version_matrix']
    uses: ./.github/workflows/subflow-build-packages.yml
    secrets: inherit
    with:
      matrix: ${{ needs.version_matrix.outputs.matrix }}

  build_images:
    name: Build Container Images
    if: needs.version_matrix.result == 'success' && always()
    needs: ['version_matrix', 'build_packages']
    uses: ./.github/workflows/subflow-build-container-images.yml
    secrets: inherit
    with:
      matrix: ${{ needs.version_matrix.outputs.matrix }}
